# Complete Startup Guide - Todo App with Authentication

## Overview

This guide will help you start the full-stack todo application with Better Auth authentication.

**Stack:**
- Frontend: Next.js 15+ with Better Auth (Port 3000)
- Backend: FastAPI with JWT validation (Port 8000)
- Database: Neon PostgreSQL (Serverless)

## Prerequisites Checklist

- [x] Node.js 18+ installed
- [x] Python 3.13+ installed
- [x] Environment variables configured
- [x] Database migrations run
- [x] Dependencies installed

## Quick Start (5 minutes)

### Step 1: Start Backend Server

```bash
# Navigate to backend directory
cd backend

# Activate virtual environment
source .venv/bin/activate  # Linux/Mac
# OR
.venv\Scripts\activate  # Windows

# Start FastAPI server
uvicorn src.main:app --reload --port 8000
```

**Verify backend is running:**
```bash
curl http://localhost:8000/health
# Expected output: {"status":"ok","environment":"development","version":"0.1.0"}
```

### Step 2: Start Frontend Server

Open a **new terminal window**:

```bash
# Navigate to frontend directory
cd frontend

# Start Next.js development server
npm run dev
```

**You should see:**
```
✓ Ready in 2-3 seconds
○ Local:        http://localhost:3000
```

### Step 3: Test Authentication

1. **Open Browser**: Navigate to http://localhost:3000

2. **Create Account**:
   - Go to http://localhost:3000/auth/sign-up
   - Fill in:
     - Name: "Test User"
     - Email: "test@example.com"
     - Password: "Test1234!" (min 8 chars, mixed case, numbers, symbols)
   - Click "Create account"
   - Should redirect instantly to `/dashboard`

3. **Sign Out and Sign In**:
   - Click "Sign Out" in dashboard
   - Go to http://localhost:3000/auth/sign-in
   - Enter email and password
   - Should redirect instantly to `/dashboard`

## Architecture Overview

```
┌─────────────────────────────────────────────────────────────────┐
│                    Browser (localhost:3000)                      │
│  ┌────────────┐         ┌────────────┐         ┌────────────┐  │
│  │  Sign-In   │────────▶│ Better Auth│────────▶│ Dashboard  │  │
│  │   Page     │         │  (cookies) │         │    Page    │  │
│  └────────────┘         └────────────┘         └────────────┘  │
│                                │                       │         │
└────────────────────────────────┼───────────────────────┼─────────┘
                                 │                       │
                    ┌────────────▼───────────┐          │
                    │ Neon PostgreSQL DB     │          │
                    │ - user table           │          │
                    │ - session table        │          │
                    │ - account table        │          │
                    │ - tasks table          │          │
                    └────────────────────────┘          │
                                                         │
                                    JWT Token Exchange   │
                                         │               │
┌────────────────────────────────────────┼───────────────▼─────────┐
│              Next.js API Route         │                         │
│         GET /api/auth/token ───────────┘                         │
│                                │                                  │
│         Returns JWT Token      │                                 │
│         (signed with BETTER_AUTH_SECRET)                         │
└────────────────────────────────┼──────────────────────────────────┘
                                 │
                                 │ Authorization: Bearer <JWT>
                                 │
┌────────────────────────────────▼──────────────────────────────────┐
│                    Backend API (localhost:8000)                   │
│  ┌──────────────────┐      ┌──────────────────┐                 │
│  │ JWT Middleware   │─────▶│  Task API        │                 │
│  │ (validates JWT)  │      │  /api/{user}/... │                 │
│  └──────────────────┘      └──────────────────┘                 │
│                                │                                  │
│                                ▼                                  │
│                    ┌────────────────────┐                        │
│                    │  Task Service      │                        │
│                    │  (Business Logic)  │                        │
│                    └────────────────────┘                        │
└───────────────────────────────────────────────────────────────────┘
```

## Authentication Flow Explained

### 1. Sign-Up/Sign-In
```
User fills form → Better Auth validates → Creates session in Neon DB →
Sets HTTP-only cookie → Redirects to dashboard
```

### 2. Making API Calls to Backend
```
Frontend needs data → Calls /api/auth/token (with Better Auth cookie) →
Gets JWT token → Sends to backend in Authorization header →
Backend validates JWT → Returns data
```

### 3. JWT Token Details
- **Generated by**: Next.js `/api/auth/token` endpoint
- **Signed with**: `BETTER_AUTH_SECRET` (shared between frontend & backend)
- **Algorithm**: HS256
- **Expiration**: 7 days
- **Claims**:
  - `sub`: User ID
  - `email`: User email
  - `iat`: Issued at timestamp
  - `exp`: Expiration timestamp

## Environment Variables

### Frontend (.env.local)
```bash
# Backend API URL
NEXT_PUBLIC_API_URL=http://localhost:8000

# Better Auth Configuration
BETTER_AUTH_SECRET=DYzLOUg2P7Tk03JxLmIItv7dvBLyyMTzr43yOOUBWJc=
BETTER_AUTH_URL=http://localhost:3000
NEXT_PUBLIC_AUTH_URL=http://localhost:3000

# Database URL (Neon PostgreSQL - for Better Auth)
DATABASE_URL=postgresql://neondb_owner:***@ep-dark-sky-a13pc5ob-pooler.ap-southeast-1.aws.neon.tech/neondb?ssl=true
```

### Backend (.env)
```bash
# Database URL (Neon PostgreSQL - for FastAPI)
DATABASE_URL=postgresql+asyncpg://neondb_owner:***@ep-dark-sky-a13pc5ob-pooler.ap-southeast-1.aws.neon.tech/neondb?ssl=require

# Authentication Secret (MUST MATCH FRONTEND!)
BETTER_AUTH_SECRET=DYzLOUg2P7Tk03JxLmIItv7dvBLyyMTzr43yOOUBWJc=

# CORS Configuration
CORS_ORIGINS=http://localhost:3000,http://localhost:3001

# Application Settings
ENVIRONMENT=development
DEBUG=true
```

**CRITICAL**: `BETTER_AUTH_SECRET` must be **identical** in both frontend and backend!

## Troubleshooting

### Issue: "Failed to initialize database adapter"

**Cause**: Better Auth can't connect to PostgreSQL database

**Solutions**:
1. Check DATABASE_URL in `.env.local`:
   ```bash
   cd frontend
   cat .env.local | grep DATABASE_URL
   ```

2. Test database connection:
   ```bash
   cd frontend
   npx tsx scripts/migrate-db.ts
   ```
   Should output: ✅ Migration completed successfully!

3. Verify SSL configuration:
   - Database URL should end with `?ssl=true` (not `?sslmode=verify-full`)

### Issue: "Signing you in..." stuck, never redirects

**Cause**: Database connection or configuration error

**Debug Steps**:
1. Open browser DevTools (F12) → Console tab
2. Look for errors like:
   - "Failed to initialize database adapter" → Database connection issue
   - "Network error" → Backend not running
   - "Failed to get authentication token" → Token endpoint error

3. Check both servers are running:
   ```bash
   # Backend health check
   curl http://localhost:8000/health

   # Frontend (should return HTML)
   curl http://localhost:3000
   ```

4. Check logs in both terminal windows for errors

### Issue: Backend returns 401 Unauthorized

**Cause**: JWT validation failing

**Solutions**:
1. Verify secrets match:
   ```bash
   # Frontend
   cd frontend && cat .env.local | grep BETTER_AUTH_SECRET

   # Backend
   cd backend && cat .env | grep BETTER_AUTH_SECRET
   ```
   Should be identical!

2. Check backend logs for JWT errors:
   ```
   JWT validation error: Signature verification failed
   → Secrets don't match

   JWT validation error: Token expired
   → Token cache issue, refresh page
   ```

3. Clear browser cookies and sign in again

### Issue: Database tables don't exist

**Cause**: Migrations not run

**Solution**:
```bash
cd frontend
npx tsx scripts/migrate-db.ts
```

### Issue: Backend can't connect to database

**Cause**: Wrong database URL format

**Solution**:
Backend needs `postgresql+asyncpg://...` (note the `+asyncpg`):
```bash
cd backend
grep DATABASE_URL .env
# Should start with: postgresql+asyncpg://
```

## Testing Checklist

After starting both servers, test these scenarios:

- [ ] **Sign Up**: Create new account, redirects to dashboard
- [ ] **Sign In**: Sign in with existing account, redirects to dashboard
- [ ] **Sign Out**: Sign out, redirects to sign-in page
- [ ] **Protected Route**: Visit /dashboard without signing in, redirects to /auth/sign-in
- [ ] **Create Task**: Create a new task in dashboard (tests backend integration)
- [ ] **Toggle Task**: Mark task as complete/incomplete
- [ ] **Delete Task**: Delete a task
- [ ] **Session Persistence**: Refresh page, still signed in

## Development Commands

### Frontend
```bash
cd frontend

# Development server
npm run dev

# Type checking
npm run type-check

# Linting
npm run lint

# Build for production
npm run build

# Run production build
npm run start
```

### Backend
```bash
cd backend

# Activate virtual environment
source .venv/bin/activate  # Linux/Mac
.venv\Scripts\activate     # Windows

# Development server (auto-reload)
uvicorn src.main:app --reload --port 8000

# Run tests
pytest

# Type checking
mypy src

# Linting
ruff check src

# Database migrations
alembic revision --autogenerate -m "description"
alembic upgrade head
```

## Common Gotchas

### 1. Port Already in Use
If you see "Port 3000 is already in use":
```bash
# Linux/Mac
lsof -ti:3000 | xargs kill -9

# Windows
netstat -ano | findstr :3000
taskkill /PID <PID> /F
```

### 2. Module Not Found Errors (Frontend)
```bash
cd frontend
rm -rf node_modules .next
npm install
npm run dev
```

### 3. Python Import Errors (Backend)
```bash
cd backend
rm -rf .venv
python -m venv .venv
source .venv/bin/activate
pip install -e .
```

### 4. Database Connection Timeouts
- Neon serverless databases may "sleep" after inactivity
- First request after sleep takes ~2-3 seconds
- This is normal and automatic

### 5. Cookie Not Set in Browser
- Clear browser cookies for localhost
- Ensure BETTER_AUTH_URL is http://localhost:3000 (not 127.0.0.1)
- Check for mixed HTTP/HTTPS issues

## Production Deployment Considerations

When deploying to production:

1. **Update URLs**:
   - `BETTER_AUTH_URL` → Your production frontend URL
   - `NEXT_PUBLIC_API_URL` → Your production backend URL
   - `CORS_ORIGINS` in backend → Your production frontend URL

2. **Environment Variables**:
   - Never commit `.env` or `.env.local` files
   - Use environment variable management (Vercel, Railway, etc.)
   - Rotate `BETTER_AUTH_SECRET` if compromised

3. **Security**:
   - `useSecureCookies` auto-enables in production (HTTPS only)
   - Ensure backend uses HTTPS
   - Set proper CORS origins (no wildcards)

4. **Database**:
   - Neon automatically handles production scaling
   - Enable connection pooling for high traffic
   - Monitor database usage

5. **Testing**:
   - Test authentication flow in production environment
   - Verify JWT tokens work cross-domain
   - Check cookie settings

## Files Modified/Created

### Frontend
- `lib/auth.ts` - Better Auth configuration with Neon PostgreSQL
- `app/auth/sign-in/page.tsx` - Sign-in page with improved UX
- `app/auth/sign-up/page.tsx` - Sign-up page with improved UX
- `app/api/auth/token/route.ts` - JWT token exchange endpoint
- `lib/api.ts` - API client with JWT authentication
- `middleware.ts` - Route protection
- `.env.local` - Environment variables
- `scripts/migrate-db.ts` - Database migration script

### Backend
- `src/api/middleware/jwt_auth.py` - JWT validation (updated for cookies + headers)
- `src/config.py` - Settings configuration
- `.env` - Environment variables

## Support

If you encounter issues not covered here:

1. Check both server logs (frontend terminal + backend terminal)
2. Check browser console (F12 → Console)
3. Verify environment variables match
4. Test database connection with migration script
5. Ensure both servers are running

## Next Steps

After successful authentication:

1. **Implement Task Management**: The API endpoints are ready
2. **Add Profile Page**: Show user info, change password
3. **Implement Real-time Updates**: Add WebSockets or polling
4. **Add Email Verification**: Enable in Better Auth config
5. **Add OAuth Providers**: Google, GitHub, etc.

---

**Last Updated**: 2026-01-17
**Status**: ✅ Authentication fully working
